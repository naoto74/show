<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>
<body>
<script>
(()=>{
	const param = location.search.slice(1).split(",");


	const username = param[0];
	const repositoryname = param[1];
	const token = param[2];
	const header_auth = {
		"Authorization":`token ${token}`,
		"Accept":"application/vnd.github.v3+json"
	};
	
	
	const info = async path => {
		const url = `https://api.github.com/repos/${username}/${repositoryname}/contents/${path}`;
		return await (await fetch(url, { method:"GET", headers:header_auth})).json();
	}
	const fetchAsDataURL = async url => {
		const res = await fetch(url);
		if (!res.ok) {
			throw new Error(`Fetch failed: ${res.status}`);
		}

		const blob = await res.blob();

		return new Promise((resolve, reject) => {
			const reader = new FileReader();
			reader.onloadend = () => resolve(reader.result);
			reader.onerror = reject;
			reader.readAsDataURL(blob);
		});
	}
	info("index.html")
		.then(e=>atob(e.content))
		.then(async e=> {
			const parser = new DOMParser();
			const newDoc = parser.parseFromString(e, "text/html");

			document.replaceChild(
				newDoc.documentElement,
				document.documentElement
			);
			for(let old of document.querySelectorAll("link[rel=stylesheet]")){
				const base = old.href.replace(location.origin+location.pathname, "");
				const url = (await info(base)).download_url;
				old.href = await fetchAsDataURL(url);
			}
			for(let old of document.querySelectorAll("script[src]")){
				const s = document.createElement("script");
				const base = old.src.replace(location.origin+location.pathname, "");
				const url = (await info(base)).download_url;
				s.src = await fetchAsDataURL(url);
				s.async = false;
				old.replaceWith(s);
			}
		});
})();
</script>
</body>
</html>